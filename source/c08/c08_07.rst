8.7 OpenStack 实现GPU直通
=========================

8.7.1 环境准备
--------------

检查是否有 GPU 设备：\ ``lspci | grep NVIDIA``

|image0|

此时查看，驱动是 nvidia

|image1|

::

   [root@ws_compute11 ~]# lspci -nnk -d 10de:1bb3
   03:00.0 3D controller [0302]: NVIDIA Corporation Device [10de:1bb3] (rev a1)
       Subsystem: NVIDIA Corporation Device [10de:11d8]
       Kernel driver in use: nvidia
   04:00.0 3D controller [0302]: NVIDIA Corporation Device [10de:1bb3] (rev a1)
       Subsystem: NVIDIA Corporation Device [10de:11d8]
       Kernel driver in use: nvidia

修改内核，开启直通，在\ ``/etc/default/grub`` 文件里
``GRUB_CMDLINE_LINUX`` 行，添加 ``intel_iommu=on``

未创建虚拟机

|image2|

创建gpu虚拟机成功，driver 由 nvidia 变为 vfio-pci

|image3|

删除虚拟机成功

|image4|

在P版之前，创建gpu直通的虚拟机，在虚拟机内部能NIVIDIA显卡的驱动是能检测到自己是跑在虚拟机里的（如下图，先安装
``cpuid`` 再执行\ ``cpuid |grep hypervisor_id``
，显示KVM），如果在虚拟机里驱动就会出错，所以我们需要对显卡驱动隐藏hypervisor
id。

|image5|

在P版之前，需要开发者自己修改xml ，在 feature 标签里添加这段

.. code:: xml

       <kvm>
         <hidden state='on'/>
       </kvm>

然后destroy再start一下虚拟机，在虚拟机内部执行

|image6|

在OpenStack的Pike版本中的Glance
镜像引入了img_hide_hypervisor_id=true的property，所以可以对镜像执行如下的命令隐藏hupervisor
id。

::

   openstack image set IMG-UUID --property img_hide_hypervisor_id=true

由于我们当前使用的是 Newton 版本，所以需参考 P
版的代码进行相应的改动，在生成虚拟机的xml的时候，在feature标签内添加如下一段内容

.. code:: xml

   <kvm>
     <hidden state='on'/>
   </kvm>

具体 P版的代码如何实现，主要函数是这一行

|image7|

8.7.2 使用说明
--------------

在环境部署好，gpu
资源也充足的情况下，想要创建一台gpu直通的虚拟机，还需要确保以下两个步骤完成。

8.7.2.1 模板配置
~~~~~~~~~~~~~~~~

GPU 作为一种硬件资源，同样需要在模板中配置，配置方式是在 flavor
中添加Extra_spec

-  “pci_passthrough:alias”=“M60:1” ： M60是上面控制节点中，在nova.conf
   中配置的 pci_alias 别名。1 表示，需要一个gpu设备。
-  “pci_passthrough:alias”=“P4:2” ： P4是上面控制节点中，在nova.conf
   中配置的 pci_alias 别名。2 表示，需要两个gpu设备。

::

   `nova flavor-key <flavor_id> ``set` `pci_passthrough:``alias``=``'nvidia:1'`

8.7.2.2 镜像配置
~~~~~~~~~~~~~~~~

::

   `openstack image ``set` `<IMG-UUID> --property img_hide_hypervisor_id=``true`

--------------

.. figure:: http://image.python-online.cn/20190511161447.png
   :alt: 关注公众号，获取最新干货！


.. |image0| image:: http://image.python-online.cn/20190419144135.png
.. |image1| image:: http://image.python-online.cn/20190419144044.png
.. |image2| image:: http://image.python-online.cn/20190422201117.png
.. |image3| image:: http://image.python-online.cn/20190422201041.png
.. |image4| image:: http://image.python-online.cn/20190422201117.png
.. |image5| image:: http://image.python-online.cn/20190422205222.png
.. |image6| image:: http://image.python-online.cn/20190422204755.png
.. |image7| image:: http://image.python-online.cn/20190514205605.png

